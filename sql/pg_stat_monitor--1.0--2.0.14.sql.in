/* contrib/pg_stat_monitor/pg_stat_monitor--1.0--2.0.sql */

-- complain if script is sourced in psql, rather than via ALTER EXTENSION
\echo Use "ALTER EXTENSION pg_stat_monitor UPDATE TO '2.0'" to load this file. \quit

CREATE FUNCTION pg_stat_monitor_errors(
     OUT severity   int,
     OUT message    text,
     OUT msgtime    text,
     OUT calls      int8
 )
RETURNS SETOF record
AS 'MODULE_PATHNAME', 'pg_stat_monitor_errors'
LANGUAGE C STRICT VOLATILE PARALLEL SAFE;

CREATE OR REPLACE FUNCTION pgsm_log_severity_as_text(severity int) RETURNS TEXT AS
$$
SELECT
     CASE
         WHEN severity = 0 THEN 'INFO'
        WHEN severity = 1 THEN 'WARNING'
    WHEN severity = 2 THEN 'ERROR'
  END
$$
LANGUAGE SQL PARALLEL SAFE;

CREATE VIEW pg_stat_monitor_errors AS SELECT
    pgsm_log_severity_as_text(severity) as severity, message, msgtime, calls
FROM pg_stat_monitor_errors();

CREATE FUNCTION pg_stat_monitor_reset_errors()
RETURNS void
AS 'MODULE_PATHNAME'
LANGUAGE C PARALLEL SAFE;


GRANT SELECT ON pg_stat_monitor_errors TO PUBLIC;

-- Don't want this to be available to non-superusers.
REVOKE ALL ON FUNCTION pg_stat_monitor_reset_errors() FROM PUBLIC;
